<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attack Graph Visualization</title>
  <!-- Load Cytoscape and extensions -->
  <script src="https://unpkg.com/cytoscape@3.23.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.3.2/cytoscape-dagre.js"></script>
  <script src="https://unpkg.com/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://unpkg.com/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js"></script> <!-- Corrected Tippy.js URL -->
  <script src="https://unpkg.com/cytoscape-popper@1.0.7/cytoscape-popper.js"></script>

  <style>
    #cy {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
    }
    .tippy-box {
      background-color: white;
      border: 1px solid black;
      padding: 5px;
      font-size: 12px;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>Attack Graph Visualization</h1>
  <div id="cy"></div>

  <script>
    cytoscape.use(cytoscapeDagre); // Ensure Dagre layout is registered

    fetch('/scan/3/latest')
      .then(response => response.json())
      .then(data => {
        if (!data.attack_graph) {
          document.getElementById('cy').innerHTML = "<p>No attack graph available.</p>";
          return;
        }

        let nodes = data.attack_graph.nodes;
        let links = data.attack_graph.links;
        let elements = [];

        nodes.forEach(node => {
          elements.push({
            data: { 
              id: node.id, 
              label: node.label || node.name || node.id, 
              vulnerabilities: node.vulnerabilities || [],
              filepath: node.filepath, 
              vulnerable: Boolean(node.vulnerable),
              type: node.type
            }
          });
        });

        links.forEach(link => {
          elements.push({
            data: { 
              id: link.source + "_" + link.target, 
              source: link.source, 
              target: link.target, 
              label: link.type,
              attack_path: Boolean(link.attack_path) 
            }
          });
        });

        const cy = cytoscape({
          container: document.getElementById('cy'),
          elements: elements,
          style: [
            {
              selector: 'node',
              style: {
                'label': 'data(label)',
                'text-valign': 'center',
                'text-halign': 'center',
                'background-color': '#0074D9',
                'width': '40px',
                'height': '40px',
                'color': 'black',
                'font-size': '12px',
                'border-width': 2,
                'border-color': '#ccc'
              }
            },
            {
              selector: 'node[type="function"][vulnerable]',
              style: {
                'border-color': '#FF4136',
                'border-width': 4
              }
            },
            {
              selector: 'node[type="vulnerability"]',
              style: {
                'shape': 'diamond',
                'background-color': '#FF4136',
                'label': 'data(label)',
                'font-size': '10px',
                'color': 'black'
              }
            },
            {
              selector: 'edge',
              style: {
                'width': 2,
                'line-color': '#ccc',
                'target-arrow-color': '#ccc',
                'target-arrow-shape': 'triangle',
                'curve-style': 'bezier',
                'label': 'data(label)',
                'font-size': '8px',
                'text-rotation': 'autorotate'
              }
            },
            {
              selector: 'edge[attack_path]',
              style: {
                'width': 4,
                'line-color': '#FF0000',
                'target-arrow-color': '#FF0000',
                'target-arrow-shape': 'triangle',
                'curve-style': 'bezier'
              }
            },
            {
              selector: 'edge[type="has_vulnerability"]',
              style: {
                'width': 3,
                'line-color': '#FF4136',
                'target-arrow-color': '#FF4136',
                'target-arrow-shape': 'triangle',
                'curve-style': 'bezier'
              }
            }
          ],
          layout: {
            name: 'dagre', 
            rankDir: 'TB', 
            nodeSep: 50,
            edgeSep: 30,
            rankSep: 75
          }
        });

        // Fixing the tooltips
        cy.nodes().forEach(function (node) {
          let content = `<strong>${node.data('label')}</strong><br>`;
          content += `<strong>File:</strong> ${node.data('filepath')}<br>`;
          
          if (node.data('vulnerabilities') && node.data('vulnerabilities').length > 0) {
            content += `<strong>Vulnerabilities:</strong><br>`;
            node.data('vulnerabilities').forEach(vuln => {
              content += `<em>${vuln.message}</em> (Severity: ${vuln.severity}, Likelihood: ${vuln.likelihood}, Impact: ${vuln.impact})<br>`;
            });
          }

          content += `<strong>Calls:</strong><br>`;
          let connected = node.connectedEdges().filter(edge => edge.data('label') === 'calls');
          connected.forEach(edge => {
            content += `${edge.data('target')}<br>`;
          });

          let ref = node.popperRef(); 
          let dummyDomEle = document.createElement('div');
          dummyDomEle.innerHTML = content;
          dummyDomEle.classList.add('tippy-box');

          tippy(ref, {
            content: dummyDomEle,
            allowHTML: true,
            interactive: true,
            appendTo: document.body,
            trigger: 'manual',
            placement: 'top'
          });

          node.on('mouseover', () => dummyDomEle._tippy.show());
          node.on('mouseout', () => dummyDomEle._tippy.hide());
        });

      })
      .catch(error => {
        console.error('Error fetching scan results:', error);
      });
  </script>
</body>
</html>
